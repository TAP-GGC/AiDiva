<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>MiniGame Chat - Ai Diva</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
</head>
<body class="is-preload">
<!-- Wrapper -->
<div id="wrapper">

    <!-- Header -->
    <header id="header">
        <div class="logo">
            <img src="images/aidivalogo.png" alt="Custom Icon">
        </div>
        <div class="content">
            <div class="inner">
                <h1>20 Questions</h1>
                <p>The Ai will think of something and you have to ask if questions and correctly guess what it is.</p>
                <!-- Chat Wrapper (Contains Chat & Input) -->
                <div id="chat-wrapper">
                    <!-- Chat Container -->
                    <div id="chat-container">
                        <div id="messages"></div>
                    </div>

                    <!-- Input Container (Fixed at Bottom of Chat Box) -->
                    <div id="input-container">
                        <label for="user-input"></label><input type="text" id="user-input" placeholder="Type a message...">
                        <button onclick="sendMessage()">Send</button>
                        <button id="reset-button" onclick="resetGame()">Reset</button>
                        <button id="hint-button" onclick="hintGame()">Hint</button>
                    </div>
                </div>
            </div>
        </div>

        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
            </ul>
        </nav>
    </header>
    <!-- Footer -->
    <footer id="footer">
        <p class="copyright"></p>
    </footer>

</div>

<!-- BG -->
<div id="bg"></div>

<!-- Scripts -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>
<script>
    //storing the sessionID locally
    let sessionId = localStorage.getItem('aiDivaSessionId');

    // Function to include session ID in request URL
    function getApiUrlWithSession(endpoint) {
        const baseUrl = "https://ai-diva-42bed2958d91.herokuapp.com/api/";
        if (sessionId) {
            // Append session ID as a query parameter
            return `${baseUrl}${endpoint}?client_session_id=${sessionId}`;
        }
        return `${baseUrl}${endpoint}`;
    }

    // Function to send the message
    async function sendMessage() {
        const inputElem = document.getElementById("user-input");
        const sendButton = document.querySelector("#input-container button");
        const messagesDiv = document.getElementById("messages");

        const userInput = inputElem.value.trim();
        if (!userInput) return; // Do nothing if input is empty

        // Disable input and send button while waiting for response
        inputElem.disabled = true;
        sendButton.disabled = true;

        // Clear input field
        inputElem.value = "";

        // Append user's message to chat
        messagesDiv.innerHTML += `<div class="user-message">${userInput}</div>`;

        // Show "AI is thinking..." message
        const loadingMessage = document.createElement("div");
        loadingMessage.className = "ai-message";
        loadingMessage.textContent = "ðŸ¤– Ai Diva is thinking...";
        messagesDiv.appendChild(loadingMessage);

        try {
            // Get the URL with session ID as a query parameter if available
            const url = getApiUrlWithSession("minigame");
            console.log("Sending request to:", url);

            const response = await fetch(url, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: userInput })
            });

            console.log("Response status:", response.status);

            // Check if response is ok before processing
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Response data:", data);

            // Check for user_id in cookies
            const cookieValue = document.cookie.split('; ').find(row => row.startsWith('user_id='));
            if (cookieValue) {
                // Extract and store session ID from cookie
                const newSessionId = cookieValue.split('=')[1];
                if (newSessionId && (!sessionId || newSessionId !== sessionId)) {
                    sessionId = newSessionId;
                    localStorage.setItem('aiDivaSessionId', sessionId);
                    console.log("Updated session ID from cookie:", sessionId);
                }
            }

            // Remove the "AI is thinking..." message
            messagesDiv.removeChild(loadingMessage);

            // Append chatbot's response
            messagesDiv.innerHTML += `<div class="ai-message">${data.response}</div>`;

            // If game is over, show reset prompt
            if (data.game_over) {
                messagesDiv.innerHTML += `<div class="ai-message">Game Over! Click "Reset Game" to start again.</div>`;
            }
        } catch (error) {
            console.error("Error in sendMessage:", error);

            // Remove the loading message if it still exists
            if (messagesDiv.contains(loadingMessage)) {
                messagesDiv.removeChild(loadingMessage);
            }
            messagesDiv.innerHTML += `<div class="ai-message">Error: Unable to get a response. ${error.message}</div>`;
        } finally {
            // Re-enable input and send button after response
            inputElem.disabled = false;
            sendButton.disabled = false;
            inputElem.focus();
        }
    }

    //Function to reset game
    async function resetGame() {
        const messagesDiv = document.getElementById("messages");

        try {
            // Get the URL with session ID as a query parameter if available
            const url = getApiUrlWithSession("reset");
            console.log("Sending reset request to:", url);

            // Send reset request to backend with credentials included
            const response = await fetch(url, {
                method: "POST",
                credentials: "include"  // Ensures cookies are sent along with the request
            });

            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Reset response:", data);

            // Check for user_id in cookies
            const cookieValue = document.cookie.split('; ').find(row => row.startsWith('user_id='));
            if (cookieValue) {
                // Extract and store session ID from cookie
                const newSessionId = cookieValue.split('=')[1];
                if (newSessionId && (!sessionId || newSessionId !== sessionId)) {
                    sessionId = newSessionId;
                    localStorage.setItem('aiDivaSessionId', sessionId);
                    console.log("Updated session ID from cookie:", sessionId);
                }
            }

            // Clear chat history on frontend
            messagesDiv.innerHTML = `<div class="ai-message">Game reset! A new object has been chosen. Let's play again!</div>`;
        } catch (error) {
            console.error("Error in resetGame:", error);
            messagesDiv.innerHTML += `<div class="ai-message">Error: Unable to reset the game. ${error.message}</div>`;
        }
    }

    async function hintGame() {
        const inputElem = document.getElementById("user-input");
        const sendButton = document.querySelector("#input-container button");
        const messagesDiv = document.getElementById("messages");

        // Disable input and send button while waiting for response
        inputElem.disabled = true;
        sendButton.disabled = true;

        // Show "AI is thinking..." message
        const loadingMessage = document.createElement("div");
        loadingMessage.className = "ai-message";
        loadingMessage.textContent = "ðŸ¤– Ai Diva is thinking of a hint...";
        messagesDiv.appendChild(loadingMessage);

        try {
            // Get the URL with session ID as a query parameter if available
            const url = getApiUrlWithSession("hint");
            console.log("Sending hint request to:", url);

            const response = await fetch(url, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" }
            });

            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Hint response:", data);

            // Check for user_id in cookies
            const cookieValue = document.cookie.split('; ').find(row => row.startsWith('user_id='));
            if (cookieValue) {
                // Extract and store session ID from cookie
                const newSessionId = cookieValue.split('=')[1];
                if (newSessionId && (!sessionId || newSessionId !== sessionId)) {
                    sessionId = newSessionId;
                    localStorage.setItem('aiDivaSessionId', sessionId);
                    console.log("Updated session ID from cookie:", sessionId);
                }
            }

            //removes loading message
            messagesDiv.removeChild(loadingMessage);
            //displays messages from backend
            messagesDiv.innerHTML += `<div class="ai-message">Hint: ${data.response}</div>`;
        } catch (error) {
            console.error("Error in hintGame:", error);
            // Remove the loading message if it still exists
            if (messagesDiv.contains(loadingMessage)) {
                messagesDiv.removeChild(loadingMessage);
            }
            messagesDiv.innerHTML += `<div class="ai-message">Error: Unable to provide a hint. ${error.message}</div>`;
        } finally {
            // Re-enable input and send button after response
            inputElem.disabled = false;
            sendButton.disabled = false;
            inputElem.focus();
        }
    }

    document.getElementById("user-input").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });

    // Add this at the top of your script section
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Page loaded, checking cookies...");
        console.log("Current cookies:", document.cookie);

        // Initialize the game on page load
        initGame();
    });

    // Function to initialize the game
    async function initGame() {
        const messagesDiv = document.getElementById("messages");

        try {
            console.log("Initializing game...");
            // Send reset request to backend to initialize the game
            const response = await fetch("https://ai-diva-42bed2958d91.herokuapp.com/api/reset", {
                method: "POST",
                credentials: "include"
            });

            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Init game response:", data);
            messagesDiv.innerHTML = `<div class="ai-message">${data.message}</div>`;
            messagesDiv.innerHTML += `<div class="ai-message">Ask a yes/no question to guess what I'm thinking of!</div>`;

            // Log cookies after reset
            console.log("Cookies after reset:", document.cookie);
        } catch (error) {
            console.error("Error initializing game:", error);
            messagesDiv.innerHTML = `<div class="ai-message">Error initializing the game: ${error.message}. Please try refreshing the page.</div>`;
        }
    }
</script>
</body>
</html>
